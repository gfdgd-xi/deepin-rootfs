name: Build deepin base tar
run-name: ${{ github.actor }} Build deepin base tar ğŸš€
on:
  workflow_dispatch:
jobs:
  amd64:
    runs-on: ubuntu-24.04 # 24 æ‰æœ‰æ”¯æŒ loong æ–°ä¸–ç•Œçš„ Qemu User
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build debootstrap
        run: |
          sudo apt update
          sudo apt install git qemu-user-static fakeroot -y   # fakeroot ç”¨äºè§£å†³æ„å»º deb çš„æƒé™é—®é¢˜ï¼ŒQemu ç”¨äºè·¨æ¶æ„æ„å»º
          # æ‹‰å–æºç åŒ…
          git clone https://github.com/deepin-community/debootstrap --depth=1
          cd debootstrap
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo apt build-dep . -y
          # æ„å»º deb åŒ…
          dpkg-buildpackage -b
          # å®‰è£…ç”Ÿæˆçš„ deb åŒ…
          sudo apt install ../*.deb -y
      - name: Get gpg key
        run: |
          sudo cp deepin-archive-camel-keyring.gpg /etc/apt/trusted.gpg.d -rv

      - name: Get deepin base rootfs
        run: |
          sudo debootstrap --arch=amd64 beige deepin-rootfs https://community-packages.deepin.com/deepin/beige/

      - name: Pack tar
        run: |
          cpu=$(cat /proc/cpuinfo | grep processor | wc -l)  # è·å– CPU æ ¸å¿ƒæ•°
          cd deepin-rootfs
          sudo tar -cvf ../deepin-rootfs.tar *
          sudo xz -T $cpu ../deepin-rootfs.tar

      - name: Upload tar
        uses: actions/upload-artifact@v1
        with:
          name: deepin-rootfs-amd64
          path: deepin-rootfs.tar.xz
      
  arm64:
    runs-on: ubuntu-24.04 # 24 æ‰æœ‰æ”¯æŒ loong æ–°ä¸–ç•Œçš„ Qemu User
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build debootstrap
        run: |
          sudo apt update
          sudo apt install git qemu-user-static fakeroot -y   # fakeroot ç”¨äºè§£å†³æ„å»º deb çš„æƒé™é—®é¢˜ï¼ŒQemu ç”¨äºè·¨æ¶æ„æ„å»º
          # æ‹‰å–æºç åŒ…
          git clone https://github.com/deepin-community/debootstrap --depth=1
          cd debootstrap
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo apt build-dep . -y
          # æ„å»º deb åŒ…
          dpkg-buildpackage -b
          # å®‰è£…ç”Ÿæˆçš„ deb åŒ…
          sudo apt install ../*.deb -y
      - name: Get gpg key
        run: |
          sudo cp deepin-archive-camel-keyring.gpg /etc/apt/trusted.gpg.d -rv

      - name: Get deepin base rootfs
        run: |
          sudo debootstrap --arch=arm64 beige deepin-rootfs https://community-packages.deepin.com/deepin/beige/

      - name: Pack tar
        run: |
          cpu=$(cat /proc/cpuinfo | grep processor | wc -l)  # è·å– CPU æ ¸å¿ƒæ•°
          cd deepin-rootfs
          sudo tar -cvf ../deepin-rootfs.tar *
          sudo xz -T $cpu ../deepin-rootfs.tar

      - name: Upload tar
        uses: actions/upload-artifact@v1
        with:
          name: deepin-rootfs-arm64
          path: deepin-rootfs.tar.xz

  loong64:
    runs-on: ubuntu-24.04 # 24 æ‰æœ‰æ”¯æŒ loong æ–°ä¸–ç•Œçš„ Qemu User
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build debootstrap
        run: |
          sudo apt update
          sudo apt install git qemu-user-static fakeroot -y   # fakeroot ç”¨äºè§£å†³æ„å»º deb çš„æƒé™é—®é¢˜ï¼ŒQemu ç”¨äºè·¨æ¶æ„æ„å»º
          # æ‹‰å–æºç åŒ…
          git clone https://github.com/deepin-community/debootstrap --depth=1
          cd debootstrap
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo apt build-dep . -y
          # æ„å»º deb åŒ…
          dpkg-buildpackage -b
          # å®‰è£…ç”Ÿæˆçš„ deb åŒ…
          sudo apt install ../*.deb -y
      - name: Get gpg key
        run: |
          sudo cp deepin-archive-camel-keyring.gpg /etc/apt/trusted.gpg.d -rv

      - name: Get deepin base rootfs
        run: |
          sudo debootstrap --arch=loong64 beige deepin-rootfs https://community-packages.deepin.com/deepin/beige/

      - name: Pack tar
        run: |
          cpu=$(cat /proc/cpuinfo | grep processor | wc -l)  # è·å– CPU æ ¸å¿ƒæ•°
          cd deepin-rootfs
          sudo tar -cvf ../deepin-rootfs.tar *
          sudo xz -T $cpu ../deepin-rootfs.tar

      - name: Upload tar
        uses: actions/upload-artifact@v1
        with:
          name: deepin-rootfs-loong64
          path: deepin-rootfs.tar.xz

  riscv64:
    runs-on: ubuntu-24.04 # 24 æ‰æœ‰æ”¯æŒ loong æ–°ä¸–ç•Œçš„ Qemu User
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build debootstrap
        run: |
          sudo apt update
          sudo apt install git qemu-user-static fakeroot -y   # fakeroot ç”¨äºè§£å†³æ„å»º deb çš„æƒé™é—®é¢˜ï¼ŒQemu ç”¨äºè·¨æ¶æ„æ„å»º
          # æ‹‰å–æºç åŒ…
          git clone https://github.com/deepin-community/debootstrap --depth=1
          cd debootstrap
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo apt build-dep . -y
          # æ„å»º deb åŒ…
          dpkg-buildpackage -b
          # å®‰è£…ç”Ÿæˆçš„ deb åŒ…
          sudo apt install ../*.deb -y
      - name: Get gpg key
        run: |
          sudo cp deepin-archive-camel-keyring.gpg /etc/apt/trusted.gpg.d -rv

      - name: Get deepin base rootfs
        run: |
          sudo debootstrap --arch=riscv64 beige deepin-rootfs https://community-packages.deepin.com/deepin/beige/

      - name: Pack tar
        run: |
          cpu=$(cat /proc/cpuinfo | grep processor | wc -l)  # è·å– CPU æ ¸å¿ƒæ•°
          cd deepin-rootfs
          sudo tar -cvf ../deepin-rootfs.tar *
          sudo xz -T $cpu ../deepin-rootfs.tar

      - name: Upload tar
        uses: actions/upload-artifact@v1
        with:
          name: deepin-rootfs-riscv64
          path: deepin-rootfs.tar.xz